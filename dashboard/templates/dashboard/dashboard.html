{% extends "vault/base.html" %}

{% load i18n staticfiles dashboard_tags %}

{% block title %}{% trans 'Dashboard' %}{% endblock %}

{% block css %}
  <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/dashboard.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/widget.css' %}" />
{% endblock %}

{% block content_title %}{% trans 'Dashboard' %}{% endblock %}
{% block breadcrumb %}{% endblock %}

{% block content_top %}
  {{ block.super }}
  <a href="{% url "add_project" %}" class="btn btn-primary">{% trans 'Create Project' %}</a>
{% endblock %}

{% block content %}
  <ul class="dashboard-widgets" id="dashboard-widgets"></ul>

{% endblock %}

{% block js_bottom %}
<script src="{% static 'vendor/js/tools.bundle.js' %}"></script>
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>

<script type="text/html" id="widget_default">
  <style>
  .<%=name%> .head:hover,
  .<%=name%> .head:hover .icon { color: <%=color%> }
  .<%=name%> .item-box { background-color: <%=color%> }
  </style>

  <div class="service <%=name%>">
    <a class="head" href="<%=title_url%>">
      <i class="icon <%=icon%>"></i>
      <span class="name">
        <%=title%>
        <span class="info"><%=subtitle%></span>
      </span>
    </a>
    <div class="content">
      <div class="item-box">
        <span class="big-number">{% if projects %}{{ projects }}{% else %}0{% endif %}</span>
        {% trans 'projects' %}
      </div>
      <div class="item-box">
        <span class="big-number">{% if users %}{{ users }}{% else %}0{% endif %}</span>
        {% trans 'users' %}
      </div>

    </div> <!-- .content -->

    <div class="base">
      <a class="btn btn-xs btn-primary" href="{% url 'admin_projects' %}">Projects</a>
      <a class="btn btn-xs btn-primary" href="{% url 'admin_list_users' %}">Users</a>
    </div>
  </div>
</script>

<script type="text/javascript">
  var urls = [{% for iep in info_endpoints %}"{{iep}}",{%endfor%}];

  Promise.all(urls.map(u=>fetch(u + "?opt=widgets"))).then(responses => {
    return Promise.all(responses.map(res => res.json()));
  }).then(datas => {
    datas.forEach(data => {
      data.forEach(d => {
      var wid = document.createElement("li");
      // var widContent = document.createTextNode(JSON.stringify(d));
      // wid.appendChild(widContent);
      wid.innerHTML = tmpl("widget_default", {
        "color": "#ff0000",
        "title": "Title",
        "name": "Name",
        "title_url": "/",
        "icon": "fas fa-key",
        "subtitle": "Subtitle"
      });
      console.log(d);
      var widgets = document.getElementById("dashboard-widgets");
      widgets.appendChild(wid);
      console.log(wid);
    });

  })
});

</script>
{% endblock %}
